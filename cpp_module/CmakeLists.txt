cmake_minimum_required(VERSION 3.15)
project(MonsterBotController)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# Set Windows definitions
set(WIN32_LEAN_AND_MEAN 1)
add_definitions(-DUNICODE -D_UNICODE)

# Manual OpenCV configuration
set(OPENCV_ROOT "C:/opencv" CACHE PATH "OpenCV root directory")

# Find OpenCV includes
find_path(OpenCV_INCLUDE_DIRS
    NAMES opencv2/opencv.hpp
    PATHS "${OPENCV_ROOT}/build/include"
    REQUIRED
)

find_library(OpenCV_LIBS
    NAMES opencv_world4100  
    PATHS "${OPENCV_ROOT}/build/x64/vc16/lib"
    REQUIRED
)

if(OpenCV_INCLUDE_DIRS AND OpenCV_LIBS)
    message(STATUS "Found OpenCV includes: ${OpenCV_INCLUDE_DIRS}")
    message(STATUS "Found OpenCV library: ${OpenCV_LIBS}")
    set(OpenCV_FOUND TRUE)
else()
    message(FATAL_ERROR "OpenCV not found! Please check OPENCV_ROOT path")
endif()

# Find Python
find_package(Python REQUIRED COMPONENTS Development)

# Manual pybind11 configuration
set(PYBIND11_DIR "C:/pybind11" CACHE PATH "Path to pybind11")

find_path(PYBIND11_INCLUDE_DIR
    NAMES pybind11/pybind11.h
    PATHS "${PYBIND11_DIR}/include"
    REQUIRED
)

if(PYBIND11_INCLUDE_DIR)
    message(STATUS "Found pybind11 includes: ${PYBIND11_INCLUDE_DIR}")
else()
    message(FATAL_ERROR "pybind11 not found! Please set PYBIND11_DIR")
endif()

# Include directories
include_directories(
    include
    ${OpenCV_INCLUDE_DIRS}
    ${Python_INCLUDE_DIRS}
    ${PYBIND11_INCLUDE_DIR}
)

# Source files
set(SOURCES
    src/screen_capture.cpp
    src/mouse_controller.cpp
    src/main.cpp
)

# Create shared library
add_library(bot_controller MODULE ${SOURCES})

# Link libraries
target_link_libraries(bot_controller PRIVATE 
    ${OpenCV_LIBS}
    ${Python_LIBRARIES}
    user32.lib
    gdi32.lib
    gdiplus.lib
)

# Set output properties
set_target_properties(bot_controller PROPERTIES
    PREFIX ""
    SUFFIX ".pyd"
    LIBRARY_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/Release"
)

message(STATUS "Build configuration complete")
